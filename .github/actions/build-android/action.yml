name: 'build Android'
description: 'build Android package'
inputs:
  type:
    required: true
  apkCode:
    required: true
  name:
    required: true
  file-path:
    required: true
  SIGNING_KEY:
    required: true
  KEY_STORE_PASSWORD:
    required: true
  ALIAS:
    required: true
  KEY_PASSWORD:
    required: true
runs:
  using: "composite"
  steps:
    - uses: actions/setup-java@v2
      with:
        distribution: 'adopt'
        java-version: '8'
    - name: Clone love-android
      shell: bash
      run: |
        git clone --recurse-submodules https://github.com/26F-Studio/love-android -b CI --depth 1 --shallow-submodules
    - uses: ./.github/actions/build-love
      with:
        file-path: love-android/app/src/main/assets/game.love
    - name: Download ColdClear arm64-v8a
      uses: ./.github/actions/get-cc
      with:
        arch: android_aarch64
        dir: ColdClear/arm64-v8a
    - name: Process ColdClear arm64-v8a
      shell: bash
      run: |
        mkdir -p love-android/app/libs/arm64-v8a
        mv ColdClear/arm64-v8a/love-11.3-android/lib/arm64-v8a/libcold_clear.so love-android/app/libs/arm64-v8a
        mkdir -p libAndroid/arm64-v8a
        mv ColdClear/arm64-v8a/libs/arm64-v8a/libCCloader.so libAndroid/arm64-v8a
    - name: Download ColdClear armeabi-v7a
      uses: ./.github/actions/get-cc
      with:
        arch: android_armv7
        dir: ColdClear/armeabi-v7a
    - name: Process ColdClear armeabi-v7a
      shell: bash
      run: |
        mkdir -p love-android/app/libs/armeabi-v7a
        mv ColdClear/armeabi-v7a/love-11.3-android/lib/armeabi-v7a/libcold_clear.so love-android/app/libs/armeabi-v7a
        mkdir -p libAndroid/armeabi-v7a
        mv ColdClear/armeabi-v7a/libs/armeabi-v7a/libCCloader.so libAndroid/armeabi-v7a
    - name: Pack ColdClear
      shell: bash
      run: |
        7z a -tzip love-android/app/src/main/assets/game.love libAndroid
    - name: update Android information
      shell: bash
      run: |
        perl -p -e '
          my $name = "${{ inputs.type }}" eq "Release" ? "Techmino" : "Techmino_Snapshot";
          my $edition = lc "${{ inputs.type }}";
          s/\@appName/$name/g;
          s/\@edition/$edition/g;
        ' -i love-android/app/src/main/AndroidManifest.xml
        perl -p -e '
          my $packageName = "org.love2d.MrZ.Techmino";
          $packageName .= ".Snapshot" if "${{ inputs.type }}" eq "Snapshot";
          s/\@packageName/$packageName/g;
          s/\@versionCode/${{ inputs.apkCode }}/g;
          s/\@versionName/${{ inputs.name }}/g;
          s/\@storePassword/${{ inputs.KEY_STORE_PASSWORD }}/g;
          s/\@keyAlias/${{ inputs.ALIAS }}/g;
          s/\@keyPassword/${{ inputs.KEY_PASSWORD }}/g;
        ' -i love-android/app/build.gradle
    - name: Build Techmino
      shell: bash
      run: |
        echo "${{ inputs.SIGNING_KEY }}" | base64 -d > love-android/app/android.keystore
        chmod 777 love-android/gradlew
        cd love-android/
        ./gradlew assembleRelease
    - name: rename apk
      shell: bash
      run: mv love-android/app/build/outputs/apk/release/app-release.apk ${{ inputs.file-path }}
